name: CML - Customer Churn Training

# Déclenche le workflow sur push et pull request vers la branche dev
on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - dev

# Permissions nécessaires pour CML (écrire des commentaires PR)
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  train-and-report:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Configuration de Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 3. Installation de CML (version latest = v3+)
      - name: Setup CML
        uses: iterative/setup-cml@v3
        with:
          version: latest

      # 4. Installation des dépendances Python
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # 5. Entraînement du modèle
      - name: Train model
        run: |
          python script.py

      # 6. Création du rapport CML + publication de l'image
      - name: Create CML report
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Création du fichier report.md
          echo "# Customer Churn Model Training Report" >> report.md
          echo "" >> report.md
          echo "## Model Performance Metrics" >> report.md
          echo "" >> report.md
          cat metrics.txt >> report.md
          echo "" >> report.md

          echo "## Confusion Matrices Comparison" >> report.md
          echo "" >> report.md
          echo "Comparison of three approaches to handle class imbalance:" >> report.md
          echo "" >> report.md
          echo "1. **Without imbalance handling**" >> report.md
          echo "2. **With class weights**" >> report.md
          echo "3. **With SMOTE oversampling**" >> report.md
          echo "" >> report.md
          echo "" >> report.md

          # Insertion de l'image dans le markdown (le lien sera résolu automatiquement par CML)
          echo "![Confusion Matrix Comparison](conf_matrix.png)" >> report.md

          # Publication du rapport + upload de l'image avec la syntaxe correcte CML v3
          cml comment create report.md \
            --publish \
            --assets=conf_matrix.png \
            --watermark-title="cml-churn-report-${{ github.run_id }}"